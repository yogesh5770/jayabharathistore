name: White-Label App Factory

on:
  repository_dispatch:
    types: [build-white-label]
  workflow_dispatch:
    inputs:
      store_id:
        description: 'Store ID to build'
        required: true
      store_name:
        description: 'Custom App Name'
        required: true
      icon_url:
        description: 'Custom Icon URL'
        required: true
      user_app_name:
        description: 'User App Name'
        required: false
      delivery_app_name:
        description: 'Delivery App Name'
        required: false
      store_app_name:
        description: 'Store App Name'
        required: false

permissions:
  contents: write
  packages: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Make Gradlew Executable
      run: chmod +x gradlew

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests Pillow firebase-admin

    - name: Run White-Label Factory Script
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        STORE_ID: ${{ github.event.inputs.store_id || github.event.client_payload.store_id }}
        STORE_NAME: ${{ github.event.inputs.store_name || github.event.client_payload.store_name }}
        USER_APP_NAME: ${{ github.event.inputs.user_app_name || github.event.client_payload.user_app_name }}
        DELIVERY_APP_NAME: ${{ github.event.inputs.delivery_app_name || github.event.client_payload.delivery_app_name }}
        STORE_APP_NAME: ${{ github.event.inputs.store_app_name || github.event.client_payload.store_app_name }}
        ICON_URL: ${{ github.event.inputs.icon_url || github.event.client_payload.icon_url }}
      run: |
        python white_label_factory.py "$STORE_ID" "$STORE_NAME" "$ICON_URL" "$USER_APP_NAME" "$DELIVERY_APP_NAME" "$STORE_APP_NAME"

    - name: Upload APKs to Artifacts (Backup)
      uses: actions/upload-artifact@v4
      with:
        name: white-label-apks
        path: app/build/outputs/apk/*/debug/*.apk
